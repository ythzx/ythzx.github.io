<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mysql高级 | Peter&#39;s Blog Center</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="MySQL" />
  
  
  
  
  <meta name="description" content="1 视图">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL高级">
<meta property="og:url" content="https://github.com/ythzx/ythzx.github.io/2017/06/12/MySQL高级/index.html">
<meta property="og:site_name" content="Peter's Blog Center">
<meta property="og:description" content="1 视图">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612191559946-1997768728.png">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612170251931-23835847.jpg">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612170256431-562699986.jpg">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612193304415-1907976268.jpg">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612194403259-2006336161.jpg">
<meta property="og:image" content="http://images2015.cnblogs.com/blog/658994/201706/658994-20170613190803993-85930049.jpg">
<meta property="og:updated_time" content="2017-06-13T12:30:31.872Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL高级">
<meta name="twitter:description" content="1 视图">
<meta name="twitter:image" content="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612191559946-1997768728.png">
  
    <link rel="alternate" href="/atom.xml" title="Peter&#39;s Blog Center" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>



  <body data-spy="scroll" data-target="#toc" data-offset="50">


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="Peter&#39;s Blog Center" rel="home"> Peter&#39;s Blog Center </a>
            
          </h1>

          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">归档</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">分类</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">标签</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>




  <div id="container" style='background: rgba(255,255,255,0.5);'>
    <div id="wrap" style='background: rgba(255,255,255,0.5);'>
            
      <div id="content" class="outer" style='background: rgba(255,255,255,0.5);'>
        
          <section id="main" style="float:none;"><article id="post-MySQL高级" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      MySQL高级
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2017/06/12/MySQL高级/" class="article-date">
	  <time datetime="2017-06-12T08:02:20.394Z" itemprop="datePublished">六月 12, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1-视图"><a href="#1-视图" class="headerlink" title="1 视图"></a>1 视图</h2><a id="more"></a>
<p>设置的别名<br>create view as + SQL语句</p>
<p>用别名代表临时表</p>
<h2 id="2-触发器"><a href="#2-触发器" class="headerlink" title="2 触发器"></a>2 触发器</h2><p>对某张表增删改时，使用触发器自定义关联表，这个是数据级别的自动操作</p>
<p><strong>所谓的前后是用C语言写的装饰器</strong>，这中间先解析<br>new  :insert 有<br>old :delete </p>
<p>updata 都有</p>
<h2 id="3-函数"><a href="#3-函数" class="headerlink" title="3 函数"></a>3 函数</h2><p><strong>内置函数</strong>：<br>    聚合函数<br>    select curdate();– 获得当前时间<br>    字符串<br>    时间类<br>        格式化时间 DATE_FORMAT(时间，“%”)<br><strong>自定义函数</strong>:</p>
<pre><code><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">	delimeter \\   <span class="comment">-- 修改结束符</span></div><div class="line"><span class="keyword">create</span> functionf1(</div><div class="line">	i1 <span class="built_in">int</span>,</div><div class="line">    i1 <span class="built_in">int</span></div><div class="line">	</div><div class="line">)</div><div class="line"><span class="keyword">begin</span></div><div class="line">	<span class="keyword">declare</span> <span class="keyword">num</span> <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>; <span class="comment">--  声明变量</span></div><div class="line">    <span class="keyword">set</span> <span class="keyword">num</span> = i1+i2;</div><div class="line">    retuen(num);</div><div class="line"></div><div class="line"><span class="keyword">end</span> \\  <span class="comment">-- 结束</span></div><div class="line"><span class="keyword">return</span> <span class="built_in">int</span>   <span class="comment">-- 返回值必须int</span></div><div class="line">	</div><div class="line">delimeter ;  <span class="comment">--还要改回来</span></div></pre></td></tr></table></figure>
</code></pre><p>   <strong>函数调用</strong><br>   select  f1(1,100);</p>
<p>自定义函数的关键是：有返回值<br>内部不能执行SQL</p>
<h2 id="4-存储过程"><a href="#4-存储过程" class="headerlink" title="4 存储过程"></a>4 存储过程</h2><p>很重要<br>是保存在MySQL上的<strong>别名</strong>，是一坨SQL语句</p>
<p>别名</p>
<p>用于替代写SQL</p>
<p>delimiter //<br>create procedure p1()<br>begin<br>    select<br>    insert into<br>end //</p>
<p>delimiter ;</p>
<p>调用<br>call p1();</p>
<p>客户端socket发送仅仅发送 p1就行了<br>但是实际的是看公司的情况DBA<br>    方式一：<br>    MySQL：存储过程<br>    程序：调用存储过程<br>    方式二:<br>    mysql:<br>    程序：SQL语句<br>    方式三：<br>    程序：类和对象（SQL语句）</p>
<p>pymysql<br>cursor.callproc(‘p1’)</p>
<p>传参数<br>关键字 in out inout</p>
<p>创建session级别的变量<br>set @v1 =0;</p>
<p>存储过程总结：</p>
<p>可传参数<br>没有return 通过out获得<br>使用pyMySQL想要获得out的返回值的，还要查询一遍</p>
<h3 id="游标"><a href="#游标" class="headerlink" title="游标"></a>游标</h3><p>在每一行需要分门别类的时候需要</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">delimiter //</div><div class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> p6()</div><div class="line"><span class="keyword">begin</span> </div><div class="line">	<span class="keyword">declare</span> row_id <span class="built_in">int</span>; <span class="comment">-- 自定义变量1  </span></div><div class="line">	<span class="keyword">declare</span> row_num <span class="built_in">int</span>; <span class="comment">-- 自定义变量2 </span></div><div class="line">	<span class="keyword">declare</span> done <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">FALSE</span>;</div><div class="line">	<span class="keyword">declare</span> temp <span class="built_in">int</span>;</div><div class="line">	</div><div class="line">	<span class="keyword">declare</span> my_cursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">num</span> <span class="keyword">from</span> A;</div><div class="line">	<span class="keyword">declare</span> CONTINUE <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> <span class="keyword">NOT</span> <span class="keyword">FOUND</span> <span class="keyword">SET</span> done = <span class="literal">TRUE</span>;</div><div class="line">	</div><div class="line">	</div><div class="line">	</div><div class="line">	open my_cursor;</div><div class="line">		xxoo: LOOP</div><div class="line">			fetch my_cursor into row_id,row_num;</div><div class="line">			if done then </div><div class="line">				leave xxoo;</div><div class="line">			<span class="keyword">END</span> <span class="keyword">IF</span>;</div><div class="line">			<span class="keyword">set</span> temp = row_id + row_num;</div><div class="line">			<span class="keyword">insert</span> <span class="keyword">into</span> B(<span class="built_in">number</span>) <span class="keyword">values</span>(temp);</div><div class="line">		<span class="keyword">end</span> <span class="keyword">loop</span> xxoo;</div><div class="line">	close my_cursor;</div><div class="line">	</div><div class="line">	</div><div class="line"><span class="keyword">end</span>  //</div><div class="line">delimiter ;</div></pre></td></tr></table></figure>
<p>执行 call p6();</p>
<h3 id="动态执行SQL-防止SQL注入"><a href="#动态执行SQL-防止SQL注入" class="headerlink" title="动态执行SQL 防止SQL注入"></a>动态执行SQL 防止SQL注入</h3><h2 id="5-索引"><a href="#5-索引" class="headerlink" title="5 索引"></a>5 索引</h2><p><strong>查看索引</strong><br>show index from table名；<br><img src="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612191559946-1997768728.png" alt=""></p>
<p><strong> 索引的作用是约束和加速查找</strong>，通过对比在300万条数据中的查找通过索引查找的速度明显快于没有索引的</p>
<p>python生成300万条数据<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> open(<span class="string">'data.sql'</span>,<span class="string">'a'</span>,encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> f:</div><div class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">3000001</span>):</div><div class="line">		f.write(<span class="string">"insert into data(id,name,email,sex)  values('%s','aaa%s','aaa%s@xx.com','N');\n"</span> %(i,i,i))</div></pre></td></tr></table></figure></p>
<p>前提是首先创建数据库和数据表，表的名字是data.sql<br>通过数据库导入即可</p>
<h3 id="5-1-索引的分类"><a href="#5-1-索引的分类" class="headerlink" title="5.1 索引的分类"></a>5.1 索引的分类</h3><ul>
<li>主键索引 ：加速查找+不能为空+不能重复</li>
<li>普通索引 ：加速查找</li>
<li>唯一索引 ：加速查找，不能重复</li>
<li>联合索引（多列）<ul>
<li>联合主键</li>
<li>联合普通</li>
<li>联合唯一</li>
</ul>
</li>
</ul>
<h3 id="5-2-索引实际就是创建额外的数据格式"><a href="#5-2-索引实际就是创建额外的数据格式" class="headerlink" title="5.2 索引实际就是创建额外的数据格式"></a>5.2 索引实际就是创建额外的数据格式</h3><p>可以把索引看做是字典的索引，前期制作需要长的时间，但是之后查询的时间就会很快</p>
<p>制作索引的时间: 37.616s<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="keyword">name</span> <span class="keyword">on</span> <span class="keyword">data</span>(<span class="keyword">name</span>) ;</div></pre></td></tr></table></figure></p>
<p>创建索引后的查询时间是0.148s<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'aaa999'</span>;</div></pre></td></tr></table></figure></p>
<h3 id="5-3-索引的种类"><a href="#5-3-索引的种类" class="headerlink" title="5.3 索引的种类"></a>5.3 索引的种类</h3><ul>
<li><p>hash索引</p>
<p>  这个适合查找单值<br>  不适合查找范围<br>  把name转换成哈希值，查找的时候直接就对应这个</p>
</li>
<li><p>btree索引</p>
<p>  二叉树<br>  在MySQL中的应用最广<br>  二叉树，左边数字小，右边数字大，也是把name转换成相应的数字，查找的时候是按照层查找，如1024个数字，仅仅通过10层就可以查找到，是2的n次方的关系。</p>
</li>
</ul>
<h3 id="索引的建立"><a href="#索引的建立" class="headerlink" title="索引的建立"></a>索引的建立</h3><ul>
<li>建立索引需要建立额外的数据结构</li>
<li>但是插入数据慢（就如同在字典的索引中进行添加）</li>
</ul>
<h3 id="5-4-命中索引"><a href="#5-4-命中索引" class="headerlink" title="5.4 命中索引"></a>5.4 命中索引</h3><p>命中索引的意思是用到了索引，结果是查询速度快</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span>  <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'%aaa8889'</span>;</div><div class="line"><span class="keyword">explain</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span>  <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'%aaa8889'</span>;</div></pre></td></tr></table></figure>
<p>可以看到下面的type类型，第一个是ref,这个是命中索引，第二个是进行了全局搜索，没有命中索引<br><img src="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612170251931-23835847.jpg" alt=""></p>
<p><img src="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612170256431-562699986.jpg" alt=""></p>
<h4 id="5-4-1-主键索引"><a href="#5-4-1-主键索引" class="headerlink" title="5.4.1 主键索引"></a>5.4.1 主键索引</h4><ul>
<li>惟一地标识一行 ，不能为空</li>
<li>作为一个可以被外键有效引用的对象。</li>
</ul>
<blockquote>
<p><a href="http://www.nowamagic.net/librarys/veda/detail/1954" target="_blank" rel="external">http://www.nowamagic.net/librarys/veda/detail/1954</a></p>
</blockquote>
<h4 id="5-4-2-普通索引"><a href="#5-4-2-普通索引" class="headerlink" title="5.4.2 普通索引"></a>5.4.2 普通索引</h4><p>普通索引没有任何限制</p>
<ul>
<li>创建：create index 索引名 on table名（列名）；</li>
<li>删除：drop index +索引名 on table名；</li>
</ul>
<h4 id="5-4-3-唯一索引"><a href="#5-4-3-唯一索引" class="headerlink" title="5.4.3 唯一索引"></a>5.4.3 唯一索引</h4><p>唯一索引和普通索引类似，但是不同的而是，<strong>索引值必须唯一</strong>，但是允许有空值。<br>如果<strong>是组合索引</strong>，则列值的组合必须唯一</p>
<ul>
<li>创建：create unique index 索引名 on table名（列名）；</li>
<li>删除：drop  index +索引名 on table名；</li>
</ul>
<p><strong>注意的是删除的时候不用加unique</strong></p>
<h4 id="5-4-4-组合索引（最左前缀匹配原则）"><a href="#5-4-4-组合索引（最左前缀匹配原则）" class="headerlink" title="5.4.4  组合索引（最左前缀匹配原则）"></a>5.4.4  组合索引（最左前缀匹配原则）</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">create</span> <span class="keyword">unique</span> <span class="keyword">INDEX</span> union_index <span class="keyword">on</span> <span class="keyword">data</span>(<span class="keyword">name</span>,email);</div></pre></td></tr></table></figure>
<p><img src="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612193304415-1907976268.jpg" alt=""></p>
<p><strong>下面就是最左分配原则</strong><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'aaa888'</span>;<span class="comment">-- 这种是索引</span></div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'aaa888'</span> <span class="keyword">and</span> email=<span class="string">'aaa888@xx.com'</span>;<span class="comment">--这种是命中索引</span></div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> email=<span class="string">'aaa888@xx.com'</span>；<span class="comment">--没有命中索引</span></div></pre></td></tr></table></figure></p>
<p>证明<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'aaa888'</span>;</div><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span>=<span class="string">'aaa888'</span> <span class="keyword">and</span> email=<span class="string">'aaa888@xx.com'</span>;</div><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> email=<span class="string">'aaa888@xx.com'</span>;</div></pre></td></tr></table></figure></p>
<p>从下面可以看出最后的是ALL，是从数据库的整体进行搜索。<br><img src="http://images2015.cnblogs.com/blog/658994/201706/658994-20170612194403259-2006336161.jpg" alt=""></p>
<h4 id="5-4-5-索引的两个名词"><a href="#5-4-5-索引的两个名词" class="headerlink" title="5.4.5 索引的两个名词"></a>5.4.5 索引的两个名词</h4><ul>
<li><p><strong>覆盖索引</strong></p>
<p>  覆盖索引是指从创建的“索引文件”(btree或者hash)中直接获取数据<br>  如创建了name的普通索引</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">NAME</span>=<span class="string">'aaa9999'</span>；<span class="comment">--这个句式覆盖索引</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><strong>索引合并</strong><br>  索引合并是把多个<strong>单列</strong>索引合并使用<br>  如分别创建了name，email两个索引  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">NAME</span>=<span class="string">'aaa9999'</span> <span class="keyword">and</span> email=<span class="string">'aaa9999@xx.com'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="5-4-6-区别组合索引-和索引合并"><a href="#5-4-6-区别组合索引-和索引合并" class="headerlink" title="5.4.6 区别组合索引 和索引合并"></a>5.4.6 区别组合索引 和索引合并</h4><p>首先，组合索引的效率高于索引合并<br><strong>组合索引</strong>：</p>
<pre><code>- (name,email,) 
</code></pre><p><strong>索引合并</strong>：</p>
<pre><code>- name
- email
</code></pre><h4 id="5-5-实际中是频繁查找的列创建索引"><a href="#5-5-实际中是频繁查找的列创建索引" class="headerlink" title="5.5 实际中是频繁查找的列创建索引"></a>5.5 实际中是频繁查找的列创建索引</h4><p>虽然创建了索引，但是实际在查询中关键是命中索引，最直接的现象就是查询速度慢，这个通过慢日志进行查询。</p>
<p><strong>没有命中索引的特殊情况：</strong></p>
<ul>
<li><p>like ‘%xx’ 模糊查询</p>
<p>  select * from tb1 where email like ‘%cn’;</p>
</li>
<li><p>使用函数</p>
<p>  select * from tb1 where reverse(email) = ‘abc’;<br>  如</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">explaint <span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">where</span> <span class="keyword">REVERSE</span>(email)=<span class="string">'aaa222@xx.com'</span></div></pre></td></tr></table></figure>
<p>  结果中：type是all,所以是没有命中索引</p>
</li>
<li><p>or</p>
<p>  <strong>下面的情况只有id有索引，name没有索引，会全局搜索</strong></p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">`data`</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>= <span class="number">10000</span> <span class="keyword">or</span> <span class="keyword">name</span> =<span class="string">'aaa999@xx.com'</span></div></pre></td></tr></table></figure>
<p>  这个ID是索引 name不是索引的时候，遇见or，索引就不会命中，而且获得的内容是第一个</p>
<p>  <strong>特殊情况：在or中可以命中索引的情况<br>  这种情况是id和name都是索引</strong></p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">`data`</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>= <span class="number">10000</span> <span class="keyword">or</span> <span class="keyword">name</span> =<span class="string">'aaa999@xx.com'</span></div></pre></td></tr></table></figure>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">`data`</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>= <span class="number">10000</span> <span class="keyword">or</span> email=<span class="string">'aaa888@xx.com'</span> <span class="keyword">and</span> <span class="keyword">name</span> =<span class="string">'aaa999@xx.com'</span> <span class="comment">-- name 是索引    **这时查询的结果是第一个id的**</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>类型不一致</p>
<p>  如果列是字符串类型，传入条件是必须用<strong>引号</strong>引起来</p>
</li>
<li><p>！=</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">name</span>!=<span class="string">'aaa999'</span><span class="comment">--不会命中索引</span></div></pre></td></tr></table></figure>
<p>  但是主键依然会走索引，但是数据特别大的话，查询的还是很慢的</p>
</li>
<li><p>&gt;</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from tb1 where email &gt; &apos;aaa&apos;</div></pre></td></tr></table></figure>
<p>  <strong>特殊情况</strong><br>  如果是主键或索引是整数类型，则还是会走索引，在数据量很大的情况是查询也是很慢的</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> elect * from tb1 where nid &gt; 123</div><div class="line">select * from tb1 where num &gt; 123</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>order by</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT name from data ORDER BY name desc;--这种消耗 了410秒</div></pre></td></tr></table></figure>
</li>
<li><p>组合索引最左前缀<br>  看上面5.4.4的内容</p>
</li>
</ul>
<h4 id="5-6-MySQL执行预估操作"><a href="#5-6-MySQL执行预估操作" class="headerlink" title="5.6 MySQL执行预估操作"></a>5.6 MySQL执行预估操作</h4><p><strong>关于命中索引的情况：</strong></p>
<p>在SQL语句前面加上explain ，看返回的type<br> <strong>all &lt; index &lt; range &lt; index_merge &lt; ref_or_null &lt; ref &lt; eq_ref &lt; system/const</strong></p>
<blockquote>
<p><a href="http://www.cnblogs.com/stevenchen2016/p/5770214.html" target="_blank" rel="external">http://www.cnblogs.com/stevenchen2016/p/5770214.html</a></p>
</blockquote>
<p>type:: all 代表全表扫描<br>type：congst代表索引</p>
<h4 id="5-7-慢日志"><a href="#5-7-慢日志" class="headerlink" title="5.7 慢日志"></a>5.7 慢日志</h4><p>针对在前面的未命中索引的情况，导致的结果是SQL语句的执行效率低，运行时间长，DBA通过开启慢日志查看然后进行优化</p>
<blockquote>
<p>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过<strong>long_query_time</strong>值的SQL，则会被记录到慢查询日志中。<strong>long_query_time的默认值为10</strong>，意思是运行10S以上的语句。默认情况下，Mysql数据库并不启动慢查询日志，需要我们手动来设置这个参数，当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件，也支持将日志记录写入数据库表。</p>
</blockquote>
<p><strong>配置</strong></p>
<ul>
<li><p>内存</p>
<p>   show variables  like ‘%slow_query_log%’;<br>   默认是OFF，通过<strong>set global slow_query_log=1;</strong><br>   <img src="http://images2015.cnblogs.com/blog/658994/201706/658994-20170613190803993-85930049.jpg" alt=""></p>
</li>
<li><p>配置文件（修改my.cnf文件）</p>
<p>  mysqld –defaults-file=’E:\mysql-5.7.16-winx64\mysql-5.7.16-winx64\my-default.ini’<br>  my.conf内容：</p>
<ul>
<li>slow_query_log = ON</li>
<li>slow_query_log_file = D:/….<br><strong>修改后需要重启服务</strong>    </li>
</ul>
</li>
</ul>
<p>使用set global slow_query_log=1开启了慢查询日志只对当前数据库生效，如果MySQL<strong>重启后则会失效</strong>。如果要永久生效，就必须修改配置文件my.cnf（其它系统变量也是如此）</p>
<h4 id="5-8-分页操作"><a href="#5-8-分页操作" class="headerlink" title="5.8 分页操作"></a>5.8 分页操作</h4><p>分页的情况有有简单的，有最优化的，看博客园分页，并没有把全部的展现，最多显示200页。</p>
<ul>
<li><p>在索引表中扫描</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SELECT B.id from (SELECT id from `data` LIMIT 200000,10) as B;--limit不能放在子查询中，需要设置临时表</div></pre></td></tr></table></figure>
</li>
<li><p>最优方案（<strong>记录当前页面的最大最小ID</strong>）</p>
<p>  页面只有上一页，下一页</p>
<ul>
<li><p>下一页<br><strong>记录当前页面的最大ID，这里设置成了200</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span>  <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>&gt;<span class="number">200</span> <span class="keyword">LIMIT</span> <span class="number">10</span></div></pre></td></tr></table></figure>
</li>
<li><p>上一页</p>
<p><strong>这里记录了当前页面的最小ID</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span>  <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>&lt;<span class="number">200</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">DESC</span> <span class="keyword">limit</span> <span class="number">10</span>；<span class="comment">--通过order by desc 倒序排序</span></div><div class="line"></div><div class="line"><span class="keyword">SELECT</span> B.id,B.name,B.email <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> * <span class="keyword">from</span>  <span class="keyword">data</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>&lt;<span class="number">200</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span> <span class="keyword">DESC</span> <span class="keyword">limit</span> <span class="number">10</span>)<span class="keyword">as</span> B <span class="keyword">ORDER</span> <span class="keyword">BY</span> B.id ;<span class="comment">--对其排序</span></div></pre></td></tr></table></figure>
</li>
<li><p><strong>上下页之间有页码选择</strong></p>
<p>如：<em>上一页 192 193  [196]  197  198  199 下一页</em></p>
</li>
</ul>
</li>
</ul>
<p>注意：id不一定是连续的，中间的记录有可能删除，所以在不能用between and的范围进行查找</p>
<h2 id="6-ORM-操作"><a href="#6-ORM-操作" class="headerlink" title="6 ORM 操作"></a>6 ORM 操作</h2><p>ORM 对象-关系-映射</p>
<p>参考内容：</p>
<p><a href="http://www.cnblogs.com/wupeiqi/articles/5716963.html" target="_blank" rel="external">http://www.cnblogs.com/wupeiqi/articles/5716963.html</a></p>
<p><a href="http://www.cnblogs.com/aquilahkj/archive/2011/11/07/2240310.html" target="_blank" rel="external">http://www.cnblogs.com/aquilahkj/archive/2011/11/07/2240310.html</a></p>
<p><a href="http://www.cnblogs.com/stevenchen2016/p/5770214.html" target="_blank" rel="external">http://www.cnblogs.com/stevenchen2016/p/5770214.html</a></p>
<p><a href="http://www.cnblogs.com/wupeiqi/articles/5713330.html" target="_blank" rel="external">http://www.cnblogs.com/wupeiqi/articles/5713330.html</a></p>
<p><a href="http://blog.51yip.com/mysql/972.html" target="_blank" rel="external">http://blog.51yip.com/mysql/972.html</a></p>
<p><a href="http://www.cnblogs.com/kerrycode/p/5593204.html" target="_blank" rel="external">http://www.cnblogs.com/kerrycode/p/5593204.html</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/">MySQL</a></li></ul>

      
        
	<div id="comment">
	
	<!-- 多说评论框 start -->
	 <div class="ds-thread" data-thread-key="/2017/06/12/MySQL高级/" data-title="MySQL高级" data-url="https://github.com/ythzx/ythzx.github.io/2017/06/12/MySQL高级/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"ythzx"};
	  (function() {
	    var ds = document.createElement('script');
	    ds.type = 'text/javascript';ds.async = true;
	    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	    ds.charset = 'UTF-8';
	    (document.getElementsByTagName('head')[0] 
	     || document.getElementsByTagName('body')[0]).appendChild(ds);
	  })();
	  </script>
	<!-- 多说公共JS代码 end -->
	
	</div>
	<link rel="stylesheet" href="/css/comment.css">


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/06/15/Django操作数据库/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          Django操作数据库
        
      </div>
    </a>
  
  
    <a href="/2017/06/06/mysql进阶/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">MySQL 外键 表的查询</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-视图"><span class="nav-number">1.</span> <span class="nav-text">1 视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-触发器"><span class="nav-number">2.</span> <span class="nav-text">2 触发器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-函数"><span class="nav-number">3.</span> <span class="nav-text">3 函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-存储过程"><span class="nav-number">4.</span> <span class="nav-text">4 存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#游标"><span class="nav-number">4.1.</span> <span class="nav-text">游标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态执行SQL-防止SQL注入"><span class="nav-number">4.2.</span> <span class="nav-text">动态执行SQL 防止SQL注入</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-索引"><span class="nav-number">5.</span> <span class="nav-text">5 索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-索引的分类"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 索引的分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-索引实际就是创建额外的数据格式"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 索引实际就是创建额外的数据格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-索引的种类"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 索引的种类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引的建立"><span class="nav-number">5.4.</span> <span class="nav-text">索引的建立</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-命中索引"><span class="nav-number">5.5.</span> <span class="nav-text">5.4 命中索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-1-主键索引"><span class="nav-number">5.5.1.</span> <span class="nav-text">5.4.1 主键索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-2-普通索引"><span class="nav-number">5.5.2.</span> <span class="nav-text">5.4.2 普通索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-3-唯一索引"><span class="nav-number">5.5.3.</span> <span class="nav-text">5.4.3 唯一索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-4-组合索引（最左前缀匹配原则）"><span class="nav-number">5.5.4.</span> <span class="nav-text">5.4.4  组合索引（最左前缀匹配原则）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-5-索引的两个名词"><span class="nav-number">5.5.5.</span> <span class="nav-text">5.4.5 索引的两个名词</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-4-6-区别组合索引-和索引合并"><span class="nav-number">5.5.6.</span> <span class="nav-text">5.4.6 区别组合索引 和索引合并</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-5-实际中是频繁查找的列创建索引"><span class="nav-number">5.5.7.</span> <span class="nav-text">5.5 实际中是频繁查找的列创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-6-MySQL执行预估操作"><span class="nav-number">5.5.8.</span> <span class="nav-text">5.6 MySQL执行预估操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-7-慢日志"><span class="nav-number">5.5.9.</span> <span class="nav-text">5.7 慢日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-8-分页操作"><span class="nav-number">5.5.10.</span> <span class="nav-text">5.8 分页操作</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-ORM-操作"><span class="nav-number">6.</span> <span class="nav-text">6 ORM 操作</span></a></li></ol>
    
    </div>
  </aside>
</section>
            <script type="text/javascript" src="//ra.revolvermaps.com/0/0/6.js?i=0ffcolhjeyf&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2018 Peter&#39;s Blog Center All Rights Reserved.
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>






<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?93b40df12317201527431272f20ac28a";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>


  <script type="text/javascript" color="33,33,33" zindex="-1" opacity="1" count="80" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
</body>
</html>
